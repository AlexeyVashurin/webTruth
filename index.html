<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Telegram TWA SDK Test</title>
</head>
<body>
<h1>Telegram TWA SDK Test</h1>
<button id="triggerBuy">Trigger Buy</button>

<!-- Используем type="module" для поддержки ES-модулей -->
<script type="module">
    // Импортируем SDK как значение по умолчанию
    import TWA from "https://cdn.skypack.dev/@twa-dev/sdk";

    // Функция-обертка для безопасного показа сообщений.
    // Если метод TWA.showAlert вызовет ошибку (из-за вызова showPopup),
    // мы переключаемся на нативный alert.
    function safeShowAlert(message) {
        try {
            TWA.showAlert(message);
        } catch (error) {
            console.warn("TWA.showAlert не поддерживается, используем native alert.", error);
            alert(message);
        }
    }

    // Инициализация SDK
    TWA.ready();
    safeShowAlert("SDK loaded and ready!");

    // Обработчик клика для запуска процесса покупки
    document.getElementById("triggerBuy").addEventListener("click", async () => {
        console.log("Trigger Buy clicked");
        try {
            // Запрос к серверу для получения ссылки инвойса.
            // Замените URL и передаваемые данные по необходимости.
            const response = await fetch('https://sucisique.beget.app/generate-invoice', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ /* добавьте необходимые данные */ })
            });

            if (!response.ok) {
                throw new Error("Failed to get invoice link");
            }

            const data = await response.json();
            const invoiceLink = data.invoiceLink;
            console.log("Invoice link received:", invoiceLink);

            // Если метод openInvoice доступен, вызываем его
            if (typeof TWA.openInvoice === "function") {
                TWA.openInvoice(invoiceLink, (status) => {
                    console.log("Payment status:", status);
                    if (status === "paid") {
                        safeShowAlert("Payment successful!");
                    } else {
                        safeShowAlert("Payment not completed. Status: " + status);
                    }
                });
            } else {
                console.error("openInvoice method is not available");
                safeShowAlert("Your Telegram client does not support openInvoice.");
            }
        } catch (error) {
            console.error("Error during triggerBuy:", error);
            safeShowAlert("An error occurred: " + error.message);
        }
    });
</script>
</body>
</html>
