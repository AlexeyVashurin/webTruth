<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Telegram WebApp Test</title>
    <!-- Подключаем Telegram WebApp SDK синхронно -->
    <script src="https://telegram.org/js/telegram-webapp.js"></script>
</head>
<body>
<h1>Telegram WebApp Test</h1>
<button id="buyBtn">Trigger Buy</button>

<script>
    // Инициализация Telegram WebApp после полной загрузки страницы
    window.addEventListener("load", () => {
        if (window.Telegram && window.Telegram.WebApp) {
            Telegram.WebApp.ready();
            console.log("Telegram WebApp SDK загружен и готов!");
        } else {
            console.error("Telegram WebApp SDK не доступен. Приложение должно быть запущено в Telegram.");
        }
    });

    // Обработчик клика по кнопке
    document.getElementById("buyBtn").addEventListener("click", async function() {
        console.log("Вызов triggerBuy()");
        try {
            // Запрос к серверу для получения ссылки инвойса
            const response = await fetch('https://sucisique.beget.app/generate-invoice', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ /* Если нужны данные, передайте их сюда */ })
            });

            if (!response.ok) {
                throw new Error("Ошибка получения ссылки инвойса");
            }

            const data = await response.json();
            const invoiceLink = data.invoiceLink;
            console.log("Получена ссылка инвойса:", invoiceLink);

            // Проверяем, что платеж доступен на мобильных устройствах
            const platform = Telegram.WebApp.initDataUnsafe?.platform;
            if (platform !== "android" && platform !== "ios") {
                console.error("Платежи доступны только в мобильном приложении Telegram.");
                alert("Платежи доступны только в мобильном приложении Telegram.");
                return;
            }

            // Открываем платежное окно через Telegram WebApp
            Telegram.WebApp.openInvoice(invoiceLink, (status) => {
                console.log("Статус оплаты:", status);
                if (status === "paid") {
                    alert("Оплата прошла успешно!");
                } else {
                    alert("Оплата не завершена, статус: " + status);
                }
            });
        } catch (error) {
            console.error("Ошибка в triggerBuy:", error);
        }
    });
</script>
</body>
</html>
