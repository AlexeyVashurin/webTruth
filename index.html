<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Telegram WebApp Test</title>
    <!-- Подключаем Telegram WebApp SDK без async, чтобы загрузка происходила синхронно -->
    <script src="https://telegram.org/js/telegram-webapp.js"></script>
</head>
<body>
<h1>Telegram WebApp Test</h1>
<button onclick="triggerBuy()">Trigger Buy</button>

<script>
    // Дождемся загрузки страницы
    document.addEventListener("DOMContentLoaded", () => {
        if (window.Telegram && window.Telegram.WebApp) {
            // Инициализируем Telegram WebApp
            window.Telegram.WebApp.ready();
            console.log("Telegram WebApp SDK загружен и готов!");
        } else {
            console.error("Telegram WebApp SDK не доступен. Приложение должно быть запущено в Telegram.");
        }
    });

    // Функция triggerBuy доступна глобально (может быть вызвана из Unity или кнопки)
    async function triggerBuy() {
        console.log("Вызов triggerBuy()");
        try {
            // Запрос к вашему серверу для получения ссылки инвойса.
            // Замените URL на публичный URL вашего сервера (например, через ngrok или доменное имя)
            const response = await fetch('https://sucisique.beget.app/generate-invoice', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({}) // Передайте необходимые данные, если нужно
            });

            if (!response.ok) {
                throw new Error("Ошибка получения ссылки инвойса");
            }

            const data = await response.json();
            const invoiceLink = data.invoiceLink;
            console.log("Получена ссылка инвойса:", invoiceLink);

            // Проверяем наличие SDK перед использованием
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.openInvoice(invoiceLink, (status) => {
                    console.log("Статус оплаты:", status);
                    if (status === "paid") {
                        alert("Оплата прошла успешно!");
                    } else {
                        alert("Оплата не завершена, статус: " + status);
                    }
                });
            } else {
                console.error("Telegram WebApp SDK не доступен");
            }
        } catch (error) {
            console.error("Ошибка в triggerBuy:", error);
        }
    }

    // Делаем triggerBuy глобальной
    window.triggerBuy = triggerBuy;
</script>
</body>
</html>
